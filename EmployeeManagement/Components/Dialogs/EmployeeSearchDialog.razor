@using EmployeeManagement.Domain.Interfaces
@using EmployeeManagement.Domain.Models
@using EmployeeManagement.Domain.Enums
@using EmployeeManagement.Application.Interfaces
@using MudBlazor
@using Microsoft.Extensions.Logging
@inject IEmployeeRepository EmployeeRepository
@inject IEmployeeSearchService EmployeeSearchService
@inject ILogger<EmployeeSearchDialog> Logger
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 800px;">
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-4">
                ğŸ” ç¤¾å“¡æ¤œç´¢
            </MudText>

            <!-- æ¤œç´¢æ¡ä»¶ -->
            <MudCard Elevation="2" Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-3">æ¤œç´¢æ¡ä»¶</MudText>
                    <MudGrid Spacing="3">
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="searchCriteria.EmployeeNumber"
                                        Label="ç¤¾å“¡ç•ªå·"
                                        Variant="Variant.Outlined"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Badge"
                                        Class="mb-2" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="searchCriteria.Name"
                                        Label="æ°å"
                                        Variant="Variant.Outlined"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Person"
                                        Class="mb-2" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSelect @bind-Value="searchCriteria.Department"
                                     Label="éƒ¨ç½²"
                                     Variant="Variant.Outlined"
                                     AnchorOrigin="Origin.BottomCenter"
                                     Class="mb-2">
                                <MudSelectItem Value="@((Department?)null)">ï¼ˆã™ã¹ã¦ï¼‰</MudSelectItem>
                                @foreach (Department dept in Enum.GetValues<Department>())
                                {
                                    <MudSelectItem Value="@((Department?)dept)">@dept.ToDisplayName()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSelect @bind-Value="searchCriteria.Position"
                                     Label="å½¹è·"
                                     Variant="Variant.Outlined"
                                     AnchorOrigin="Origin.BottomCenter"
                                     Class="mb-2">
                                <MudSelectItem Value="@((Domain.Enums.Position?)null)">ï¼ˆã™ã¹ã¦ï¼‰</MudSelectItem>
                                @foreach (Domain.Enums.Position pos in Enum.GetValues<Domain.Enums.Position>())
                                {
                                    <MudSelectItem Value="@((Domain.Enums.Position?)pos)">@pos.ToDisplayName()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" Class="text-center">
                            <MudButton Variant="Variant.Filled"
                                     Color="Color.Primary"
                                     StartIcon="@Icons.Material.Filled.Search"
                                     OnClick="SearchEmployees"
                                     Disabled="@isSearching">
                                @if (isSearching)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>æ¤œç´¢ä¸­...</span>
                                }
                                else
                                {
                                    <span>æ¤œç´¢</span>
                                }
                            </MudButton>
                            <MudButton Variant="Variant.Outlined"
                                     Color="Color.Secondary"
                                     StartIcon="@Icons.Material.Filled.Clear"
                                     OnClick="ClearSearch"
                                     Class="ml-2">
                                ã‚¯ãƒªã‚¢
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- æ¤œç´¢çµæœ -->
            @if (searchResults != null)
            {
                <MudCard Elevation="2">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-3">
                            æ¤œç´¢çµæœ (@searchResults.Count() ä»¶)
                        </MudText>
                        
                        @if (searchResults.Any())
                        {
                            <MudDataGrid T="Employee" Items="@searchResults" 
                                       Hover="true" 
                                       RowClick="@RowClickEvent"
                                       SelectedItem="@selectedEmployee"
                                       SelectedItemChanged="@((Employee item) => selectedEmployee = item)"
                                       RowClassFunc="@GetRowClass"
                                       Height="400px"
                                       FixedHeader="true">
                                <Columns>
                                    <PropertyColumn Property="x => x.EmployeeNumber" Title="ç¤¾å“¡ç•ªå·" />
                                    <PropertyColumn Property="x => x.Name" Title="æ°å" />
                                    <PropertyColumn Property="x => x.CurrentDepartmentDisplayName" Title="éƒ¨ç½²" />
                                    <PropertyColumn Property="x => x.CurrentPositionDisplayName" Title="å½¹è·" />
                                    <PropertyColumn Property="x => x.Email" Title="Email" />
                                </Columns>
                            </MudDataGrid>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">
                                è©²å½“ã™ã‚‹ç¤¾å“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚
                            </MudAlert>
                        }
                    </MudCardContent>
                </MudCard>
            }

            @if (selectedEmployee != null)
            {
                <MudCard Elevation="2" Class="mt-3">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle1" Color="Color.Success" Class="mb-2">é¸æŠä¸­ã®ç¤¾å“¡</MudText>
                        <MudAlert Severity="Severity.Success">
                            <div style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.PersonPin" Class="mr-2" />
                                <div>
                                    <MudText Typo="Typo.body1">
                                        <strong>@selectedEmployee.Name</strong> (@selectedEmployee.EmployeeNumber)
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="color: gray;">
                                        @selectedEmployee.CurrentDepartmentDisplayName - @selectedEmployee.CurrentPositionDisplayName
                                    </MudText>
                                </div>
                            </div>
                        </MudAlert>
                    </MudCardContent>
                </MudCard>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</MudButton>
        <MudButton OnClick="SelectEmployee" 
                 Color="Color.Primary" 
                 Variant="Variant.Filled"
                 Disabled="@(selectedEmployee == null)">
            é¸æŠ
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    /// <summary>
    /// MudBlazorãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å‚ç…§ï¼ˆCascading Parameterï¼‰
    /// </summary>
    [CascadingParameter] 
    public MudBlazor.IDialogReference? MudDialog { get; set; }
    [Parameter] public string Title { get; set; } = "ç¤¾å“¡é¸æŠ";
    [Parameter] public bool AllowClear { get; set; } = true;
    [Parameter] public Employee? SelectedEmployee { get; set; }
    [Parameter] public EmployeeSelectorMode SearchMode { get; set; } = EmployeeSelectorMode.Standard;

    private SearchCriteria searchCriteria = new();
    
    private IEnumerable<Employee>? searchResults = null;
    private Employee? selectedEmployee = null;
    private bool isSearching = false;

    protected override async Task OnInitializedAsync()
    {
        // MudDialog Cascading Parameter ã®è¨ºæ–­ãƒ­ã‚°
        Logger.LogInformation("EmployeeSearchDialog initializing - MudDialog reference: {IsNull}", 
            MudDialog == null ? "NULL" : "OK");
        
        if (MudDialog != null)
        {
            Logger.LogInformation("MudDialog successfully injected with type: {DialogType}", MudDialog.GetType().Name);
        }
        
        // åˆæœŸé¸æŠçŠ¶æ…‹ã®è¨­å®š
        selectedEmployee = SelectedEmployee;
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: åˆæœŸåŒ–æ™‚ã¯æ¤œç´¢çµæœã‚’ç©ºã«ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã¤
        searchResults = Enumerable.Empty<Employee>();
        
        if (SelectedEmployee != null)
        {
            // æ—¢å­˜é¸æŠãŒã‚ã‚‹å ´åˆã®ã¿ãã®æƒ…å ±ã‚’è¡¨ç¤º
            searchResults = new[] { SelectedEmployee };
        }
    }


    private async Task SearchEmployees()
    {
        isSearching = true;
        
        try
        {
            // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦é©åˆ‡ãªæ¤œç´¢æ–¹æ³•ã‚’é¸æŠ
            if (SearchMode == EmployeeSelectorMode.ManagerOnly)
            {
                // è²¬ä»»è€…å€™è£œã®ã¿ã‚’æ¤œç´¢
                var keyword = string.IsNullOrWhiteSpace(searchCriteria.EmployeeNumber) && string.IsNullOrWhiteSpace(searchCriteria.Name) 
                    ? "" 
                    : $"{searchCriteria.EmployeeNumber} {searchCriteria.Name}".Trim();
                
                searchResults = await EmployeeSearchService.SearchEligibleManagersAsync(keyword, 1000);
                
                // è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆéƒ¨é–€ãƒ»å½¹è·ï¼‰
                if (searchCriteria.Department.HasValue || searchCriteria.Position.HasValue)
                {
                    searchResults = searchResults.Where(emp =>
                        (!searchCriteria.Department.HasValue || emp.CurrentDepartment == searchCriteria.Department.Value) &&
                        (!searchCriteria.Position.HasValue || emp.CurrentPosition == searchCriteria.Position.Value)
                    );
                }
            }
            else
            {
                // æ¨™æº–æ¤œç´¢ï¼ˆå…¨ç¤¾å“¡å¯¾è±¡ï¼‰
                var criteria = new EmployeeSearchCriteria
                {
                    EmployeeNumber = searchCriteria.EmployeeNumber,
                    Name = searchCriteria.Name,
                    ActiveOnly = true
                };

                if (criteria.IsEmpty)
                {
                    // æ¤œç´¢æ¡ä»¶ãŒç©ºã®å ´åˆã¯å…¨ç¤¾å“¡ã‚’å–å¾—
                    var allEmployees = await EmployeeRepository.GetAllAsync();
                    searchResults = allEmployees.Where(emp =>
                        (!searchCriteria.Department.HasValue || emp.CurrentDepartment == searchCriteria.Department.Value) &&
                        (!searchCriteria.Position.HasValue || emp.CurrentPosition == searchCriteria.Position.Value)
                    ).OrderBy(emp => emp.EmployeeNumber);
                }
                else
                {
                    var detailedResults = await EmployeeSearchService.SearchDetailedAsync(criteria);
                    
                    // éƒ¨é–€ãƒ»å½¹è·ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
                    searchResults = detailedResults.Where(emp =>
                        (!searchCriteria.Department.HasValue || emp.CurrentDepartment == searchCriteria.Department.Value) &&
                        (!searchCriteria.Position.HasValue || emp.CurrentPosition == searchCriteria.Position.Value)
                    ).OrderBy(emp => emp.EmployeeNumber);
                }
            }
        }
        catch (Exception ex)
        {
            // ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            searchResults = Enumerable.Empty<Employee>();
            Logger.LogError(ex, "Employee search failed for mode {SearchMode}", SearchMode);
            Snackbar.Add("ç¤¾å“¡æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚", Severity.Error);
        }
        finally
        {
            isSearching = false;
            StateHasChanged(); // ä¸€åº¦ã®å‘¼ã³å‡ºã—ã§ååˆ†
        }
    }

    private void ClearSearch()
    {
        searchCriteria = new SearchCriteria();
        selectedEmployee = null;
        searchResults = null;
        StateHasChanged();
    }

    private void RowClickEvent(DataGridRowClickEventArgs<Employee> args)
    {
        selectedEmployee = args.Item;
        StateHasChanged();
    }

    /// <summary>
    /// é¸æŠã•ã‚ŒãŸè¡Œã«CSSã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰
    /// é¸æŠä¸­ã®ç¤¾å“¡è¡Œã«è¦–è¦šçš„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æä¾›
    /// </summary>
    /// <param name="employee">å¯¾è±¡ã®ç¤¾å“¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ</param>
    /// <param name="rowIndex">è¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</param>
    /// <returns>é©ç”¨ã™ã‚‹CSSã‚¯ãƒ©ã‚¹å</returns>
    private string GetRowClass(Employee employee, int rowIndex)
    {
        // é¸æŠä¸­ã®ç¤¾å“¡ã¨ä¸€è‡´ã™ã‚‹å ´åˆã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
        return selectedEmployee != null && selectedEmployee.EmployeeNumber == employee.EmployeeNumber
            ? "employee-search-selected-row"
            : string.Empty;
    }

    /// <summary>
    /// ç¤¾å“¡é¸æŠæ™‚ã®å‡¦ç†
    /// ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã¦é¸æŠã•ã‚ŒãŸç¤¾å“¡ã‚’è¿”ã™
    /// </summary>
    private void SelectEmployee()
    {
        if (selectedEmployee == null)
        {
            Logger.LogWarning("SelectEmployee called but no employee was selected");
            Snackbar.Add("ç¤¾å“¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", Severity.Warning);
            return;
        }

        try
        {
            Logger.LogInformation("Employee selected: {EmployeeNumber} - {Name}", 
                selectedEmployee.EmployeeNumber, selectedEmployee.Name);

            // MudDialog ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® null ãƒã‚§ãƒƒã‚¯ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            if (MudDialog == null)
            {
                Logger.LogError("MudDialog cascading parameter is null - dialog cannot be closed properly");
                Snackbar.Add("ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
                return;
            }

            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’æ­£å¸¸çµ‚äº†ã¨ã—ã¦é–‰ã˜ã‚‹
            MudDialog.Close(DialogResult.Ok(selectedEmployee));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error occurred while closing dialog with selected employee {EmployeeNumber}", 
                selectedEmployee.EmployeeNumber);
            Snackbar.Add("é¸æŠå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
        }
    }

    /// <summary>
    /// ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
    /// ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ…‹ã§é–‰ã˜ã‚‹
    /// </summary>
    private void Cancel()
    {
        try
        {
            Logger.LogInformation("Employee search dialog cancelled");

            // MudDialog ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® null ãƒã‚§ãƒƒã‚¯ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            if (MudDialog == null)
            {
                Logger.LogError("MudDialog cascading parameter is null - dialog cannot be closed properly");
                Snackbar.Add("ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
                return;
            }

            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«çŠ¶æ…‹ã§é–‰ã˜ã‚‹
            MudDialog.Close(DialogResult.Cancel());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error occurred while cancelling dialog");
            Snackbar.Add("ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
        }
    }


    private class SearchCriteria
    {
        public string EmployeeNumber { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public Department? Department { get; set; } = null;
        public Domain.Enums.Position? Position { get; set; } = null;
    }
}