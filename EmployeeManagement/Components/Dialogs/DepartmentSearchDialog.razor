@using EmployeeManagement.Domain.Models
@using EmployeeManagement.Domain.Enums
@using EmployeeManagement.Application.Interfaces
@using MudBlazor
@using Microsoft.Extensions.Logging
@inject IDepartmentSearchService DepartmentSearchService
@inject ILogger<DepartmentSearchDialog> Logger
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 900px;">
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-4">
                ğŸ¢ éƒ¨é–€æ¤œç´¢
            </MudText>

            <!-- æ¤œç´¢æ¡ä»¶ -->
            <MudCard Elevation="2" Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-3">æ¤œç´¢æ¡ä»¶</MudText>
                    <MudGrid Spacing="3">
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="searchCriteria.DepartmentCode"
                                        Label="éƒ¨é–€ã‚³ãƒ¼ãƒ‰"
                                        Variant="Variant.Outlined"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Tag"
                                        Class="mb-2" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="searchCriteria.DepartmentName"
                                        Label="éƒ¨é–€å"
                                        Variant="Variant.Outlined"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Business"
                                        Class="mb-2" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="searchCriteria.ManagerName"
                                        Label="è²¬ä»»è€…å"
                                        Variant="Variant.Outlined"
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Person"
                                        Class="mb-2" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSelect @bind-Value="searchCriteria.DepartmentType"
                                     Label="éƒ¨é–€ç¨®åˆ¥"
                                     Variant="Variant.Outlined"
                                     AnchorOrigin="Origin.BottomCenter"
                                     Class="mb-2">
                                <MudSelectItem Value="@((Department?)null)">ï¼ˆã™ã¹ã¦ï¼‰</MudSelectItem>
                                @foreach (Department dept in Enum.GetValues<Department>())
                                {
                                    <MudSelectItem Value="@((Department?)dept)">@dept.ToDisplayName()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSelect @bind-Value="searchCriteria.IsActive"
                                     Label="æœ‰åŠ¹çŠ¶æ…‹"
                                     Variant="Variant.Outlined"
                                     AnchorOrigin="Origin.BottomCenter"
                                     Class="mb-2">
                                <MudSelectItem Value="@((bool?)null)">ï¼ˆã™ã¹ã¦ï¼‰</MudSelectItem>
                                <MudSelectItem Value="@((bool?)true)">æœ‰åŠ¹</MudSelectItem>
                                <MudSelectItem Value="@((bool?)false)">ç„¡åŠ¹</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudButton Variant="Variant.Filled"
                                     Color="Color.Primary"
                                     StartIcon="@Icons.Material.Filled.Search"
                                     OnClick="HandleSearch"
                                     Disabled="isSearching"
                                     FullWidth="true"
                                     Class="mt-1">
                                @if (isSearching)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                                    <MudText Class="ms-2">æ¤œç´¢ä¸­...</MudText>
                                }
                                else
                                {
                                    <MudText>æ¤œç´¢å®Ÿè¡Œ</MudText>
                                }
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- æ¤œç´¢çµæœ -->
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-3">
                        æ¤œç´¢çµæœ (@searchResults.Count() ä»¶)
                    </MudText>

                    @if (isSearching)
                    {
                        <div class="d-flex justify-center pa-4">
                            <MudProgressCircular Color="Color.Primary" Size="Size.Medium" Indeterminate="true" />
                        </div>
                    }
                    else if (!searchResults.Any())
                    {
                        <MudAlert Severity="Severity.Info">
                            è©²å½“ã™ã‚‹éƒ¨é–€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@searchResults" 
                                  Hover="true" 
                                  Striped="true" 
                                  Dense="true"
                                  RowClass="cursor-pointer"
                                  OnRowClick="OnRowClick"
                                  T="DepartmentMaster"
                                  RowClassFunc="@GetRowClass">
                            <HeaderContent>
                                <MudTh>éƒ¨é–€ã‚³ãƒ¼ãƒ‰</MudTh>
                                <MudTh>éƒ¨é–€å</MudTh>
                                <MudTh>è²¬ä»»è€…</MudTh>
                                <MudTh>éƒ¨é–€ç¨®åˆ¥</MudTh>
                                <MudTh>å†…ç·šç•ªå·</MudTh>
                                <MudTh>æœ‰åŠ¹</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="éƒ¨é–€ã‚³ãƒ¼ãƒ‰">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Tag" 
                                               Size="Size.Small" 
                                               Class="mr-2" />
                                        <strong>@context.DepartmentCode</strong>
                                    </div>
                                </MudTd>
                                <MudTd DataLabel="éƒ¨é–€å">
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Business" 
                                               Size="Size.Small" 
                                               Class="mr-2" />
                                        @context.DepartmentName
                                    </div>
                                </MudTd>
                                <MudTd DataLabel="è²¬ä»»è€…">
                                    @if (!string.IsNullOrEmpty(context.ManagerName))
                                    {
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Person" 
                                                   Size="Size.Small" 
                                                   Class="mr-2" />
                                            @context.ManagerName
                                            @if (!string.IsNullOrEmpty(context.ManagerEmployeeNumber))
                                            {
                                                <MudText Typo="Typo.caption" Class="ml-1">
                                                    (@context.ManagerEmployeeNumber)
                                                </MudText>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Default">
                                            æœªè¨­å®š
                                        </MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="éƒ¨é–€ç¨®åˆ¥">
                                    <MudChip T="string"
                                           Label="true" 
                                           Size="Size.Small"
                                           Color="Color.Info">
                                        @context.DepartmentType.ToDisplayName()
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="å†…ç·šç•ªå·">
                                    @if (!string.IsNullOrEmpty(context.Extension))
                                    {
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Phone" 
                                                   Size="Size.Small" 
                                                   Class="mr-1" />
                                            @context.Extension
                                        </div>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Default">
                                            -
                                        </MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="æœ‰åŠ¹">
                                    <MudSwitch @bind-Value="context.IsActive" 
                                             ReadOnly="true"
                                             Color="@(context.IsActive ? Color.Success : Color.Default)" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudCardContent>
            </MudCard>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" 
                 Variant="Variant.Outlined" 
                 Color="Color.Secondary">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </MudButton>
        <MudButton OnClick="@(() => SelectDepartment(selectedDepartment))" 
                 Variant="Variant.Filled" 
                 Color="Color.Primary"
                 Disabled="@(selectedDepartment == null)">
            é¸æŠ
        </MudButton>
    </DialogActions>
</MudDialog>

<style>
    .cursor-pointer {
        cursor: pointer;
    }
    
    .selected-row {
        background-color: var(--mud-palette-action-selected) !important;
    }
</style>

@code {
    private DepartmentSearchCriteria searchCriteria = new();
    private List<DepartmentMaster> searchResults = new();
    private DepartmentMaster? selectedDepartment;
    private bool isSearching = false;

    [CascadingParameter] public MudBlazor.IMudDialogInstance? MudDialog { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("DepartmentSearchDialog initializing - MudDialog reference: {IsNull}", 
            MudDialog == null ? "NULL" : "OK");
            
        try
        {
            // åˆæœŸè¡¨ç¤ºã§ã¯æœ‰åŠ¹ãªéƒ¨é–€ã®ã¿ã‚’è¡¨ç¤º
            searchCriteria.IsActive = true;
            await HandleSearch();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "DepartmentSearchDialogåˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            Snackbar.Add("åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
        }
    }

    /// <summary>
    /// æ¤œç´¢å®Ÿè¡Œ
    /// </summary>
    private async Task HandleSearch()
    {
        try
        {
            isSearching = true;
            selectedDepartment = null;
            StateHasChanged();

            Logger.LogDebug("éƒ¨é–€æ¤œç´¢å®Ÿè¡Œ: {@SearchCriteria}", searchCriteria);

            var results = await DepartmentSearchService.SearchDepartmentsAsync(searchCriteria);
            searchResults = results.ToList();

            Logger.LogDebug("éƒ¨é–€æ¤œç´¢å®Œäº†: çµæœä»¶æ•°={Count}", searchResults.Count);

            if (searchResults.Count == 0)
            {
                Snackbar.Add("è©²å½“ã™ã‚‹éƒ¨é–€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", Severity.Info);
            }
            else
            {
                Snackbar.Add($"{searchResults.Count}ä»¶ã®éƒ¨é–€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "éƒ¨é–€æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            Snackbar.Add("æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
            searchResults.Clear();
        }
        finally
        {
            isSearching = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è¡Œã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    /// </summary>
    /// <param name="tableRowClickEventArgs">è¡Œã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆå¼•æ•°</param>
    private void OnRowClick(TableRowClickEventArgs<DepartmentMaster> tableRowClickEventArgs)
    {
        try
        {
            var clickedDepartment = tableRowClickEventArgs.Item;
            
            if (clickedDepartment != null)
            {
                selectedDepartment = selectedDepartment?.DepartmentCode == clickedDepartment.DepartmentCode 
                    ? null // åŒã˜è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é¸æŠè§£é™¤
                    : clickedDepartment; // ç•°ãªã‚‹è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é¸æŠ

                Logger.LogDebug("éƒ¨é–€é¸æŠ: {DepartmentCode} - {DepartmentName}", 
                    selectedDepartment?.DepartmentCode, selectedDepartment?.DepartmentName);
                    
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "è¡Œã‚¯ãƒªãƒƒã‚¯å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            Snackbar.Add("é¸æŠå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
        }
    }

    /// <summary>
    /// è¡Œã®CSSã‚¯ãƒ©ã‚¹ã‚’å–å¾—
    /// </summary>
    /// <param name="department">éƒ¨é–€ãƒã‚¹ã‚¿</param>
    /// <param name="rowNumber">è¡Œç•ªå·</param>
    /// <returns>CSSã‚¯ãƒ©ã‚¹å</returns>
    private string GetRowClass(DepartmentMaster department, int rowNumber)
    {
        if (selectedDepartment != null && selectedDepartment.DepartmentCode == department.DepartmentCode)
        {
            return "selected-row";
        }
        return string.Empty;
    }

    /// <summary>
    /// éƒ¨é–€é¸æŠå‡¦ç†
    /// </summary>
    /// <param name="department">é¸æŠã•ã‚ŒãŸéƒ¨é–€</param>
    private void SelectDepartment(DepartmentMaster? department)
    {
        try
        {
            if (department != null && MudDialog != null)
            {
                Logger.LogInformation("éƒ¨é–€é¸æŠç¢ºå®š: {DepartmentCode} - {DepartmentName}", 
                    department.DepartmentCode, department.DepartmentName);
                    
                MudDialog.Close(DialogResult.Ok(department));
            }
            else if (department == null)
            {
                Logger.LogWarning("é¸æŠã•ã‚ŒãŸéƒ¨é–€ãŒnullã§ã™");
                Snackbar.Add("éƒ¨é–€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", Severity.Warning);
            }
            else
            {
                Logger.LogError("MudDialogãŒnullã§ã™");
                Snackbar.Add("ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "éƒ¨é–€é¸æŠç¢ºå®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            Snackbar.Add("é¸æŠå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", Severity.Error);
        }
    }

    /// <summary>
    /// ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
    /// </summary>
    private void Cancel()
    {
        try
        {
            Logger.LogDebug("éƒ¨é–€æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
            MudDialog?.Cancel();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        }
    }
}