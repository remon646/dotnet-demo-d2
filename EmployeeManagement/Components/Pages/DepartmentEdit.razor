@page "/departments/edit/{DepartmentCode}"
@using EmployeeManagement.Domain.Interfaces
@using EmployeeManagement.Domain.Models
@using EmployeeManagement.Domain.Enums
@using EmployeeManagement.Components
@using EmployeeManagement.Components.Dialogs
@using EmployeeManagement.Application.Interfaces
@using EmployeeManagement.ViewModels
@using EmployeeManagement.Constants
@using EmployeeManagement.Models
@using MudBlazor
@using Microsoft.AspNetCore.Components
@inherits AuthRequiredComponentBase

@* æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹æŒ‡å‘ã®ä¾å­˜æ€§æ³¨å…¥ *@
@inject DepartmentEditViewModel ViewModel
@inject IDepartmentDataService DataService
@inject IDepartmentUIService UIService
@inject IManagerValidationService ManagerValidationService
@inject IDepartmentValidationService ValidationService
@inject IEmployeeSearchService SearchService
@inject IDialogService DialogService

@* ViewModelã®ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½¿ç”¨ *@
<PageTitle>@ViewModel.PageTitle - ç¤¾å“¡æƒ…å ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </PageTitle>

<MudBreadcrumbs Items="ViewModel.BreadcrumbItems" />

<MudContainer MaxWidth="MaxWidth.Large">
    @* ViewModelã®ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½¿ç”¨ *@
    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-4">
        ğŸ“Š @ViewModel.PageTitle
    </MudText>

    @* ViewModelã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ *@
    @if (ViewModel.CurrentDepartment != null)
    {
        <MudCard Elevation="4">
            <MudCardContent>
                <EditForm Model="@ViewModel.CurrentDepartment" OnValidSubmit="@HandleSave" FormName="DepartmentForm">
                    <DataAnnotationsValidator />
                    
                    <MudGrid Spacing="3">
                        <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">åŸºæœ¬æƒ…å ±</MudText>
                            <MudDivider Class="mb-3" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            @* ViewModelã®çŠ¶æ…‹ã‚’ä½¿ç”¨ *@
                            @if (ViewModel.IsNewDepartment)
                            {
                                <MudTextField @bind-Value="ViewModel.CurrentDepartment.DepartmentCode"
                                            Label="éƒ¨ç½²ã‚³ãƒ¼ãƒ‰"
                                            Variant="Variant.Outlined"
                                            Required="true"
                                            MaxLength="10"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.Business"
                                            AdornmentColor="Color.Primary"
                                            Class="mb-3"
                                            HelperText="éƒ¨ç½²ã‚’è­˜åˆ¥ã™ã‚‹ä¸€æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
                            }
                            else
                            {
                                <MudTextField @bind-Value="ViewModel.CurrentDepartment.DepartmentCode"
                                            Label="éƒ¨ç½²ã‚³ãƒ¼ãƒ‰"
                                            Variant="Variant.Outlined"
                                            ReadOnly="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.Business"
                                            AdornmentColor="Color.Secondary"
                                            Class="mb-3"
                                            HelperText="éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ã§ãã¾ã›ã‚“" />
                            }
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="ViewModel.CurrentDepartment.DepartmentName"
                                        Label="éƒ¨ç½²å"
                                        Variant="Variant.Outlined"
                                        Required="true"
                                        MaxLength="50"
                                        Class="mb-3" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudSelect @bind-Value="ViewModel.CurrentDepartment.DepartmentType"
                                     Label="éƒ¨ç½²åŒºåˆ†"
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     Class="mb-3">
                                @foreach (Department dept in Enum.GetValues<Department>())
                                {
                                    <MudSelectItem Value="@dept">@dept.ToDisplayName()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudDatePicker @bind-Date="ViewModel.EstablishedDate"
                                         Label="è¨­ç«‹æ—¥"
                                         Variant="Variant.Outlined"
                                         Class="mb-3" />
                        </MudItem>

                        <!-- è²¬ä»»è€…æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2 mt-4">è²¬ä»»è€…æƒ…å ±</MudText>
                            <MudDivider Class="mb-3" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <EmployeeSelectorComponent Mode="EmployeeSelectorMode.ManagerOnly"
                                                     SelectedEmployee="ViewModel.SelectedManager"
                                                     SelectedEmployeeChanged="OnManagerSelectionChanged"
                                                     Label="è²¬ä»»è€…ç¤¾å“¡ç•ªå·ï¼ˆä»»æ„ï¼‰"
                                                     Variant="Variant.Outlined"
                                                     ShowSelectedEmployeeInfo="false"
                                                     AllowClear="true"
                                                     DialogTitle="è²¬ä»»è€…é¸æŠ"
                                                     Class="mb-3"
                                                     HelperText="è²¬ä»»è€…å€™è£œã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            @if (!string.IsNullOrEmpty(ViewModel.CurrentDepartment.ManagerName))
                            {
                                <MudTextField Value="@ViewModel.CurrentDepartment.ManagerName"
                                            Label="è²¬ä»»è€…åï¼ˆè‡ªå‹•è¨­å®šï¼‰"
                                            ReadOnly="true"
                                            Variant="Variant.Outlined"
                                            Class="mb-3"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.Person"
                                            AdornmentColor="Color.Success" />
                            }
                            else if (!string.IsNullOrEmpty(ViewModel.CurrentDepartment.ManagerEmployeeNumber))
                            {
                                <MudTextField Value="@("ç¤¾å“¡ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")"
                                            Label="è²¬ä»»è€…å"
                                            ReadOnly="true"
                                            Variant="Variant.Outlined"
                                            Class="mb-3"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.Warning"
                                            AdornmentColor="Color.Warning"
                                            HelperText="ç¤¾å“¡ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" />
                            }
                            else
                            {
                                <MudTextField Value="@("è²¬ä»»è€…æœªè¨­å®š")"
                                            Label="è²¬ä»»è€…å"
                                            ReadOnly="true"
                                            Variant="Variant.Outlined"
                                            Class="mb-3"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.PersonOutline"
                                            AdornmentColor="Color.Default"
                                            HelperText="è²¬ä»»è€…ã‚’è¨­å®šã™ã‚‹å ´åˆã¯ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
                            }
                        </MudItem>

                        @if (!string.IsNullOrEmpty(ViewModel.CurrentDepartment.ManagerEmployeeNumber) && !string.IsNullOrEmpty(ViewModel.CurrentDepartment.ManagerName))
                        {
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Success" Class="mb-3">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <MudIcon Icon="@Icons.Material.Filled.PersonPin" Class="mr-2" />
                                            <strong>è²¬ä»»è€…è¨­å®šæ¸ˆã¿:</strong> @ViewModel.CurrentDepartment.ManagerName (@ViewModel.CurrentDepartment.ManagerEmployeeNumber)
                                        </div>
                                        <MudIconButton Icon="@Icons.Material.Filled.Clear" 
                                                     Size="Size.Small" 
                                                     Color="Color.Default"
                                                     OnClick="ClearManager" 
                                                     Title="è²¬ä»»è€…è¨­å®šã‚’ã‚¯ãƒªã‚¢" />
                                    </div>
                                </MudAlert>
                            </MudItem>
                        }

                        <!-- è©³ç´°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2 mt-4">è©³ç´°æƒ…å ±</MudText>
                            <MudDivider Class="mb-3" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="ViewModel.CurrentDepartment.Extension"
                                        Label="å†…ç·šç•ªå·"
                                        Variant="Variant.Outlined"
                                        MaxLength="10"
                                        Class="mb-3" />
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudSwitch @bind-Value="ViewModel.CurrentDepartment.IsActive"
                                     Label="æœ‰åŠ¹"
                                     Color="Color.Primary"
                                     Class="mb-3" />
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField @bind-Value="ViewModel.CurrentDepartment.Description"
                                        Label="èª¬æ˜"
                                        Variant="Variant.Outlined"
                                        Lines="3"
                                        MaxLength="500"
                                        Class="mb-3" />
                        </MudItem>

                        @if (!ViewModel.IsNewDepartment)
                        {
                            <!-- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æƒ…å ± -->
                            <MudItem xs="12">
                                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2 mt-4">ä½œæˆãƒ»æ›´æ–°æƒ…å ±</MudText>
                                <MudDivider Class="mb-3" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField Value="@ViewModel.CreatedAtDisplay"
                                            Label="ä½œæˆæ—¥æ™‚"
                                            Variant="Variant.Outlined"
                                            ReadOnly="true"
                                            Class="mb-3" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField Value="@ViewModel.UpdatedAtDisplay"
                                            Label="æ›´æ–°æ—¥æ™‚"
                                            Variant="Variant.Outlined"
                                            ReadOnly="true"
                                            Class="mb-3" />
                            </MudItem>
                        }

                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <MudItem xs="12" Class="text-center mt-4">
                            <MudStack Row Justify="Justify.Center" Spacing="3">
                                <MudButton Variant="Variant.Outlined" 
                                         Color="Color.Secondary" 
                                         OnClick="Cancel"
                                         StartIcon="@Icons.Material.Filled.Cancel">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </MudButton>
                                <MudButton Variant="Variant.Filled" 
                                         Color="Color.Primary" 
                                         ButtonType="ButtonType.Submit"
                                         StartIcon="@Icons.Material.Filled.Save"
                                         Disabled="@ViewModel.IsSaving">
                                    @if (ViewModel.IsSaving)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                        <span class="ml-2">ä¿å­˜ä¸­...</span>
                                    }
                                    else
                                    {
                                        <span>@(ViewModel.IsNewDepartment ? "ä½œæˆ" : "æ›´æ–°")</span>
                                    }
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </EditForm>
            </MudCardContent>
        </MudCard>
    }
    else if (ViewModel.IsLoading)
    {
        <div class="text-center py-4">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Class="mt-2">èª­ã¿è¾¼ã¿ä¸­...</MudText>
        </div>
    }
    else
    {
        <MudAlert Severity="Severity.Error">
            æŒ‡å®šã•ã‚ŒãŸéƒ¨é–€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
        </MudAlert>
    }
</MudContainer>

@code {
    /// <summary>
    /// éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆURLçµŒç”±ã§å–å¾—ï¼‰
    /// "new" ã®å ´åˆã¯æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
    /// </summary>
    [Parameter] public string DepartmentCode { get; set; } = string.Empty;

    /// <summary>
    /// æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    /// </summary>
    private bool isNewDepartment => DepartmentCode == "new";

    /// <summary>
    /// èªè¨¼å®Œäº†å¾Œã®åˆæœŸåŒ–å‡¦ç†
    /// </summary>
    protected override async Task OnAuthenticatedAsync()
    {
        await InitializeAsync();
    }

    /// <summary>
    /// ç”»é¢åˆæœŸåŒ–å‡¦ç†
    /// ViewModelã®åˆæœŸåŒ–ã¨å¿…è¦ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ
    /// </summary>
    private async Task InitializeAsync()
    {
        try
        {
            if (isNewDepartment)
            {
                // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
                ViewModel.InitializeForNewDepartment();
            }
            else
            {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
                ViewModel.IsLoading = true;
                var result = await DataService.GetDepartmentAsync(DepartmentCode);
                
                if (result.IsSuccess && result.Department != null)
                {
                    ViewModel.InitializeForEditDepartment(result.Department);
                    
                    // è²¬ä»»è€…æƒ…å ±ã®å¾©å…ƒ
                    await RestoreManagerInfoAsync();
                }
                else
                {
                    UIService.ShowError(result.ErrorMessage);
                    ViewModel.CurrentDepartment = null;
                    ViewModel.IsLoading = false;
                }
            }
        }
        catch (Exception ex)
        {
            UIService.ShowError($"ç”»é¢åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex.Message}");
            ViewModel.IsLoading = false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    /// <summary>
    /// è²¬ä»»è€…æƒ…å ±ã®å¾©å…ƒå‡¦ç†ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
    /// </summary>
    private async Task RestoreManagerInfoAsync()
    {
        if (ViewModel.CurrentDepartment?.ManagerEmployeeNumber == null)
        {
            return;
        }

        try
        {
            var employee = await SearchService.GetByEmployeeNumberAsync(ViewModel.CurrentDepartment.ManagerEmployeeNumber);
            if (employee != null)
            {
                ViewModel.SetManager(employee);
            }
        }
        catch (Exception ex)
        {
            UIService.ShowWarning($"è²¬ä»»è€…æƒ…å ±ã®å¾©å…ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex.Message}");
        }
    }

    /// <summary>
    /// è²¬ä»»è€…è¨­å®šã‚’ã‚¯ãƒªã‚¢
    /// </summary>
    private void ClearManager()
    {
        ViewModel.ClearManager();
        UIService.ShowInfo("è²¬ä»»è€…è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
        StateHasChanged();
    }


    /// <summary>
    /// è²¬ä»»è€…é¸æŠæ™‚ã®å‡¦ç†
    /// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§è²¬ä»»è€…ã‚’è¨­å®š
    /// </summary>
    private async Task OnManagerSelectionChanged(Employee? manager)
    {
        try
        {
            if (manager != null)
            {
                // è²¬ä»»è€…ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                var validationResult = await ManagerValidationService.ValidateManagerAsync(manager.EmployeeNumber);
                
                if (validationResult.IsValid)
                {
                    ViewModel.SetManager(manager);
                    
                    if (validationResult.HasWarning)
                    {
                        UIService.ShowWarning(validationResult.WarningMessage);
                    }
                    else if (validationResult.HasSuccess)
                    {
                        UIService.ShowInfo(validationResult.SuccessMessage);
                    }
                }
                else
                {
                    ViewModel.SetManagerValidationError(validationResult.ErrorMessage);
                    UIService.ShowError(validationResult.ErrorMessage);
                }
            }
            else
            {
                ViewModel.ClearManager();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            UIService.ShowError($"è²¬ä»»è€…é¸æŠå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex.Message}");
        }
    }


    /// <summary>
    /// ä¿å­˜å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ¡ã‚½ãƒƒãƒ‰
    /// æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚’ä½¿ç”¨ã—ã¦ç°¡ç´ åŒ–
    /// </summary>
    private async Task HandleSave()
    {
        if (ViewModel.CurrentDepartment == null)
        {
            UIService.ShowError("ä¿å­˜å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

        try
        {
            // ä¿å­˜ä¸­çŠ¶æ…‹ã«å¤‰æ›´
            ViewModel.IsSaving = true;
            ViewModel.ClearFormErrors();
            StateHasChanged();

            // ä¿å­˜å‰ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™
            ViewModel.PrepareForSave();

            // ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ä¿å­˜å‡¦ç†å®Ÿè¡Œ
            ValidationResult result;
            if (ViewModel.IsNewDepartment)
            {
                result = await DataService.CreateDepartmentAsync(ViewModel.CurrentDepartment);
            }
            else
            {
                result = await DataService.UpdateDepartmentAsync(ViewModel.CurrentDepartment);
            }

            // çµæœã«åŸºã¥ã„ã¦å‡¦ç†
            if (result.IsValid)
            {
                // æˆåŠŸæ™‚ã®å‡¦ç†
                var successMessage = result.SuccessMessage ?? 
                    $"éƒ¨é–€ã€Œ{ViewModel.CurrentDepartment.DepartmentName}ã€ã®{(ViewModel.IsNewDepartment ? "ä½œæˆ" : "æ›´æ–°")}ãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
                
                await UIService.ShowSuccessAndNavigateAsync(successMessage, "/departments", DepartmentEditConstants.SUCCESS_MESSAGE_DELAY_MS);
            }
            else
            {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                if (result.ErrorMessages.Any())
                {
                    UIService.ShowMultipleErrors(result.ErrorMessages, "ä¿å­˜å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                    
                    // ViewModelã«ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’è¨­å®š
                    foreach (var error in result.ErrorMessages)
                    {
                        ViewModel.AddFormError(error);
                    }
                }
                else
                {
                    UIService.ShowError("ä¿å­˜å‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            }
        }
        catch (Exception ex)
        {
            UIService.ShowError($"ä¿å­˜å‡¦ç†ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex.Message}");
        }
        finally
        {
            // ä¿å­˜ä¸­çŠ¶æ…‹ã‚’è§£é™¤
            ViewModel.IsSaving = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
    /// UIServiceã‚’ä½¿ç”¨ã—ãŸçµ±ä¸€çš„ãªç”»é¢é·ç§»
    /// </summary>
    private void Cancel()
    {
        UIService.NavigateTo("/departments");
    }
}