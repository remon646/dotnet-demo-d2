@page "/departments"
@using EmployeeManagement.Domain.Interfaces
@using EmployeeManagement.Domain.Models
@using EmployeeManagement.Domain.Enums
@using EmployeeManagement.Application.Interfaces
@using EmployeeManagement.Components
@using MudBlazor
@inherits AuthRequiredComponentBase
@inject IDepartmentRepository DepartmentRepository
@inject IEmployeeRepository EmployeeRepository
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>éƒ¨é–€ãƒã‚¹ã‚¿ç®¡ç† - ç¤¾å“¡æƒ…å ±ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </PageTitle>

<MudBreadcrumbs Items="_breadcrumbItems" />

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudGrid Spacing="4">
        <!-- Header -->
        <MudItem xs="12">
            <MudGrid AlignItems="Center">
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.h4" Color="Color.Primary">
                        ğŸ“Š éƒ¨é–€ãƒã‚¹ã‚¿ç®¡ç†
                    </MudText>
                </MudItem>
                <MudItem xs="12" md="6" Class="text-right">
                    <MudButton Variant="Variant.Filled"
                             Color="Color.Primary"
                             StartIcon="@Icons.Material.Filled.Add"
                             OnClick="@CreateDepartment">
                        æ–°è¦è¿½åŠ 
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudItem>

        <!-- Statistics Dashboard -->
        <MudItem xs="12">
            <MudGrid Spacing="3">
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4" Class="pa-4 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Primary">ç·éƒ¨é–€æ•°</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@totalDepartments</MudText>
                    </MudCard>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4" Class="pa-4 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Success">æœ‰åŠ¹éƒ¨é–€</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@activeDepartments</MudText>
                    </MudCard>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4" Class="pa-4 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" Color="Color.Warning" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Warning">è²¬ä»»è€…è¨­å®šæ¸ˆ</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Warning">@departmentsWithManager</MudText>
                    </MudCard>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="4" Class="pa-4 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.Update" Size="Size.Large" Color="Color.Info" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Info">æœ€çµ‚æ›´æ–°</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Info">@lastUpdateDate.ToString("yyyy/MM/dd")</MudText>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudItem>

        <!-- Data Grid -->
        <MudItem xs="12">
            <MudCard Elevation="4">
                <MudCardContent>
                    <MudDataGrid T="DepartmentMaster" Items="@departments" Loading="@isLoading" Filterable="true" SortMode="SortMode.Multiple" Groupable="false">
                        <Columns>
                            <PropertyColumn Property="x => x.DepartmentCode" Title="éƒ¨ç½²ã‚³ãƒ¼ãƒ‰" />
                            <PropertyColumn Property="x => x.DepartmentName" Title="éƒ¨ç½²å" />
                            <PropertyColumn Property="x => x.ManagerName" Title="è²¬ä»»è€…" />
                            <PropertyColumn Property="x => x.DepartmentTypeDisplayName" Title="éƒ¨ç½²åŒºåˆ†" />
                            <PropertyColumn Property="x => x.EstablishedDate" Title="è¨­ç«‹æ—¥" Format="yyyy/MM/dd" />
                            <PropertyColumn Property="x => x.IsActive" Title="çŠ¶æ…‹">
                                <CellTemplate>
                                    @if (context.Item.IsActive)
                                    {
                                        <MudChip Color="Color.Success" Size="Size.Small">æœ‰åŠ¹</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip Color="Color.Error" Size="Size.Small">ç„¡åŠ¹</MudChip>
                                    }
                                </CellTemplate>
                            </PropertyColumn>
                            <TemplateColumn Title="æ“ä½œ" Sortable="false" Filterable="false">
                                <CellTemplate>
                                    <MudStack Row>
                                        <MudButton Size="Size.Small"
                                                 Variant="Variant.Filled"
                                                 Color="Color.Primary"
                                                 StartIcon="@Icons.Material.Filled.Edit"
                                                 OnClick="@(() => EditDepartment(context.Item.DepartmentCode))"
                                                 Class="mr-2">
                                            ç·¨é›†
                                        </MudButton>
                                        <MudButton Size="Size.Small"
                                                 Variant="Variant.Filled"
                                                 Color="Color.Error"
                                                 StartIcon="@Icons.Material.Filled.Delete"
                                                 OnClick="@(() => DeleteDepartment(context.Item))">
                                            å‰Šé™¤
                                        </MudButton>
                                    </MudStack>
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<DepartmentMaster> departments = new();
    private bool isLoading = true;
    
    // Statistics
    private int totalDepartments = 0;
    private int activeDepartments = 0;
    private int departmentsWithManager = 0;
    private DateTime lastUpdateDate = DateTime.MinValue;

    private List<BreadcrumbItem> _breadcrumbItems = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("ãƒ›ãƒ¼ãƒ ", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("éƒ¨é–€ãƒã‚¹ã‚¿ç®¡ç†", href: "/departments", icon: Icons.Material.Filled.Business)
    };

    protected override async Task OnAuthenticatedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            // ç·¨é›†ç”»é¢ã‹ã‚‰æˆ»ã£ã¦ããŸæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            await LoadData();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task LoadData()
    {
        isLoading = true;
        
        try
        {
            departments = (await DepartmentRepository.GetAllAsync()).ToList();
            await LoadStatistics();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadStatistics()
    {
        totalDepartments = await DepartmentRepository.GetCountAsync();
        activeDepartments = await DepartmentRepository.GetActiveCountAsync();
        departmentsWithManager = await DepartmentRepository.GetWithManagerCountAsync();
        lastUpdateDate = await DepartmentRepository.GetLastUpdateDateAsync();
    }

    private void CreateDepartment()
    {
        NavigationManager.NavigateTo("/departments/edit/new");
    }

    private void EditDepartment(string departmentCode)
    {
        NavigationManager.NavigateTo($"/departments/edit/{departmentCode}");
    }

    private async Task DeleteDepartment(DepartmentMaster department)
    {
        // Check if employees are assigned to this department
        var employees = await EmployeeRepository.GetAllAsync();
        var employeesInDepartment = employees.Count(e => e.CurrentDepartment == department.DepartmentType);

        if (employeesInDepartment > 0)
        {
            Snackbar.Add($"ã“ã®éƒ¨ç½²ã«ã¯ {employeesInDepartment} åã®ç¤¾å“¡ãŒæ‰€å±ã—ã¦ã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚", Severity.Warning);
            return;
        }

        var confirm = await DialogService.ShowMessageBox(
            "éƒ¨é–€å‰Šé™¤ã®ç¢ºèª",
            $"éƒ¨é–€ã€Œ{department.DepartmentName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚",
            yesText: "å‰Šé™¤", cancelText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«");

        if (confirm == true)
        {
            try
            {
                var success = await DepartmentRepository.DeleteAsync(department.DepartmentCode);
                if (success)
                {
                    await LoadData();
                    Snackbar.Add("éƒ¨é–€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚", Severity.Success);
                }
                else
                {
                    Snackbar.Add("éƒ¨é–€ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex.Message}", Severity.Error);
            }
        }
    }
}