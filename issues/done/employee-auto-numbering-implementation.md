# Employee Auto-Numbering Implementation

## Issue Description
社員の新規登録時に自動採番で番号を取得する機能を実装し、社員番号管理画面を削除する必要があります。現在の手動社員番号入力システムを自動採番システムに変更し、ユーザビリティを向上させます。

## Problem Analysis

### Current System Issues
1. **Manual Employee Number Input**: 新規社員登録時に手動で社員番号を入力する必要がある
   - ユーザーが適切なフォーマット（EMPYYYYNNN）を覚える必要がある
   - 重複チェックが必要で、エラーが発生しやすい
   - 連番管理が困難
   
2. **Unnecessary Management Screen**: 社員番号管理画面（`/employee-numbers`）が不要
   - 自動採番により手動管理が不要になる
   - ナビゲーション構造が複雑化している
   - 統計情報表示も社員マスター側で十分

### Current Architecture Analysis
**Already Available Components:**
- ✅ `EmployeeNumberService.GenerateNewEmployeeNumberAsync()` - 自動採番機能
- ✅ `EmployeeNumberService.IssueEmployeeNumberAsync()` - 社員番号発行機能
- ✅ スレッドセーフなConcurrentInMemoryDataStore
- ✅ 年度ベースの連番管理（EMP2024001, EMP2024002...）

**Current Employee Registration Flow:**
1. User navigates to `/employees/edit/new`
2. User manually enters employee number in format `EMPYYYYNNN`
3. System validates format and checks for duplicates
4. Employee is saved with manual employee number

## Solution Plan

### Target Architecture
**New Employee Registration Flow:**
1. User navigates to `/employees/edit/new`
2. System automatically generates next available employee number
3. User sees preview of auto-generated number (read-only)
4. Employee is saved with auto-generated employee number
5. Employee number is formally issued in EmployeeNumber management system

### Implementation Strategy
1. **Auto-Generation Integration**: Leverage existing `EmployeeNumberService`
2. **UI Simplification**: Remove manual input, show auto-generated preview
3. **Service Coordination**: Ensure employee creation and number issuance are synchronized
4. **Clean Removal**: Delete unnecessary management screens and navigation

## Files to Modify

### 1. Employee Registration Screen
**File**: `/home/a/project/dotnet-demo-d2/EmployeeManagement/Components/Pages/EmployeeEdit.razor`

#### Changes Required:
- **Auto-Generation Logic**: Add automatic employee number generation for new employees
- **UI Updates**: 
  - Remove manual input field for new employees
  - Add read-only preview field showing auto-generated number
  - Update validation logic
- **Service Integration**: Integrate with `EmployeeNumberService` for both generation and issuance

### 2. Navigation Menu Cleanup
**File**: `/home/a/project/dotnet-demo-d2/EmployeeManagement/Components/Layout/NavMenu.razor`

#### Changes Required:
- Remove navigation link to employee number management (lines 12-14)
- Maintain clean navigation structure under "社員管理"

### 3. Files to Delete
- **Main Page**: `/home/a/project/dotnet-demo-d2/EmployeeManagement/Components/Pages/EmployeeNumbers.razor`
- **Detail Dialog**: `/home/a/project/dotnet-demo-d2/EmployeeManagement/Components/Dialogs/EmployeeNumberDetailDialog.razor`
- **Issue Dialog**: `/home/a/project/dotnet-demo-d2/EmployeeManagement/Components/Dialogs/EmployeeNumberIssueDialog.razor`

## Implementation Details

### 1. EmployeeEdit.razor Modifications

#### Add Auto-Generation Logic
```csharp
private string? _autoGeneratedEmployeeNumber;

private async Task GenerateEmployeeNumberPreview()
{
    if (isNewEmployee)
    {
        _autoGeneratedEmployeeNumber = await EmployeeNumberService.GenerateNewEmployeeNumberAsync();
        if (currentEmployee != null)
        {
            currentEmployee.EmployeeNumber = _autoGeneratedEmployeeNumber;
        }
    }
}
```

#### Update OnInitialized Method
```csharp
private async void InitializeNewEmployee()
{
    currentEmployee = new Employee
    {
        EmployeeNumber = string.Empty, // Will be set by auto-generation
        Name = string.Empty,
        Email = string.Empty,
        PhoneNumber = string.Empty,
        JoinDate = DateTime.Today,
        CreatedAt = DateTime.Now,
        UpdatedAt = DateTime.Now
    };
    
    // Generate employee number preview
    await GenerateEmployeeNumberPreview();
    
    originalEmployee = null;
    joinDate = DateTime.Today;
    _selectedDepartment = Department.Sales;
    _selectedPosition = Domain.Enums.Position.General;
    StateHasChanged();
}
```

#### Update UI Component (Lines 30-40)
**Current:**
```html
<MudTextField @bind-Value="currentEmployee.EmployeeNumber"
            Label="社員番号"
            Variant="Variant.Outlined"
            ReadOnly="@(!isNewEmployee)"
            Required="true"
            MaxLength="10"
            Placeholder="EMP2024001"
            Class="mb-3"
            Disabled="@isLoading" />
```

**New:**
```html
@if (isNewEmployee)
{
    <MudTextField Value="@_autoGeneratedEmployeeNumber"
                Label="社員番号（自動生成）"
                Variant="Variant.Outlined"
                ReadOnly="true"
                Adornment="Adornment.Start"
                AdornmentIcon="Icons.Material.Filled.AutoAwesome"
                AdornmentColor="Color.Success"
                Class="mb-3"
                HelperText="新規登録時は自動で採番されます" />
}
else
{
    <MudTextField @bind-Value="currentEmployee.EmployeeNumber"
                Label="社員番号"
                Variant="Variant.Outlined"
                ReadOnly="true"
                Class="mb-3"
                Disabled="@isLoading" />
}
```

#### Update Save Logic
```csharp
if (isNewEmployee)
{
    // Ensure we have the latest generated number
    if (string.IsNullOrEmpty(currentEmployee.EmployeeNumber))
    {
        currentEmployee.EmployeeNumber = await EmployeeNumberService.GenerateNewEmployeeNumberAsync();
    }
    
    // Check if employee number already exists (safety check)
    var existingEmployee = await EmployeeRepository.GetByIdAsync(currentEmployee.EmployeeNumber);
    if (existingEmployee != null)
    {
        // Generate a new number if somehow there's a conflict
        currentEmployee.EmployeeNumber = await EmployeeNumberService.GenerateNewEmployeeNumberAsync();
    }
    
    success = await EmployeeRepository.AddAsync(currentEmployee);
    if (success)
    {
        // Issue the employee number officially
        await EmployeeNumberService.IssueEmployeeNumberAsync(
            year: DateTime.Now.Year, 
            remarks: $"新入社員: {currentEmployee.Name}"
        );
        
        Snackbar.Add("新規社員を登録しました。", Severity.Success);
        Navigation.NavigateTo("/employees");
    }
    else
    {
        Snackbar.Add("社員の登録に失敗しました。", Severity.Error);
    }
}
```

#### Remove Manual Validation
Remove the following validation logic (lines 316-321):
```csharp
// Validate employee number format for new employees
if (isNewEmployee && !IsValidEmployeeNumber(currentEmployee.EmployeeNumber))
{
    Snackbar.Add("社員番号は「EMPYYYYNNN」の形式で入力してください（例：EMP2024001）。", Severity.Warning);
    return;
}
```

### 2. NavMenu.razor Modifications

**Remove Lines 12-14:**
```html
<MudNavLink Href="/employee-numbers" Icon="Icons.Material.Filled.Badge">
    社員番号管理
</MudNavLink>
```

**Result:**
```html
<MudNavGroup Text="社員管理" Icon="Icons.Material.Filled.People" Expanded="true">
    <MudNavLink Href="/employees" Icon="Icons.Material.Filled.People">
        社員一覧・検索
    </MudNavLink>
</MudNavGroup>
```

### 3. Service Dependencies
**Required Services** (already registered in Program.cs):
- ✅ `EmployeeNumberService` - Line 46
- ✅ `IEmployeeRepository` - Line 38
- ✅ `IEmployeeNumberRepository` - Line 41

**Injection in EmployeeEdit.razor:**
```csharp
@inject EmployeeNumberService EmployeeNumberService
```

## Expected Results

### UI/UX Improvements
1. **Simplified Registration Process**:
   - No manual employee number input required
   - Automatic preview of next available number
   - Reduced user errors and validation complexity

2. **Cleaner Navigation**:
   - Simplified navigation menu structure
   - Focus on core employee management functions
   - Reduced cognitive load for users

3. **Consistent Numbering**:
   - Guaranteed sequential numbering
   - No gaps or duplicates
   - Year-based organization maintained

### Technical Benefits
1. **Reduced Code Complexity**:
   - Fewer validation rules
   - Simplified error handling
   - Automatic consistency

2. **Better Data Integrity**:
   - Thread-safe number generation
   - Atomic employee creation and number issuance
   - Consistent format enforcement

## Testing Plan

### Manual Testing Steps
1. **New Employee Registration**:
   - Navigate to `/employees/edit/new`
   - Verify auto-generated number is displayed
   - Complete employee information
   - Save and verify employee is created with correct number
   - Check that number is marked as issued in background

2. **Navigation Testing**:
   - Verify employee number management link is removed
   - Confirm navigation menu is clean and functional
   - Test that old `/employee-numbers` URL returns 404

3. **Sequential Numbering**:
   - Create multiple employees
   - Verify sequential numbering (EMP2024001, EMP2024002, etc.)
   - Test year rollover behavior

### Error Handling Tests
1. **Service Failures**:
   - Test behavior when EmployeeNumberService fails
   - Verify appropriate error messages
   - Ensure no partial data corruption

2. **Concurrent Access**:
   - Test multiple simultaneous registrations
   - Verify no duplicate numbers are generated
   - Confirm thread safety

## Integration Notes

### Service Layer Integration
- **EmployeeNumberService**: Already provides required functionality
- **Thread Safety**: ConcurrentInMemoryDataStore ensures safe concurrent access
- **Data Consistency**: Employee and EmployeeNumber records are created together

### Backward Compatibility
- **Existing Employees**: No changes to existing employee records
- **Edit Functionality**: Existing employee edit functionality unchanged
- **Data Migration**: No data migration required

## Deployment Considerations

### Zero-Downtime Deployment
1. **File Deletion**: Safe to delete unused components
2. **Navigation Changes**: Non-breaking change
3. **Auto-Generation**: New functionality, doesn't affect existing data

### Monitoring Points
1. **Employee Number Generation**: Monitor for any generation failures
2. **Registration Success Rate**: Track employee creation success
3. **Sequential Integrity**: Verify no gaps in numbering sequence

## Priority
**High** - Core functionality improvement with significant UX benefits

## Risk Assessment
**Low Risk** - Leverages existing, tested components with minimal new code

## Status
**Ready for Implementation** - All dependencies are available and architecture is sound